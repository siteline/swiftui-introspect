default_platform(:ios)
skip_docs

platform :ios do
    lane :test do |options|
        ci = ENV['CI']
        puts 'Running on CI.' if ci

        version = options[:version].to_i || 16
        devices = case version
        when 13
            [
                "iPhone 11 Pro (13.7)",
                "iPad Pro (11-inch) (2nd generation) (13.7)",
                # "Apple TV (13.4)",
            ]
        when 14
            [
                "iPhone 11 Pro (14.5)",
                "iPad Pro (11-inch) (3rd generation) (14.5)",
                # "Apple TV (14.5)",
            ]
        when 15
            [
                "iPhone 11 Pro (15.5)",
                "iPad Pro (11-inch) (3rd generation) (15.5)",
                # "Apple TV (15.4)",
            ]
        when 16
            [
                "iPhone 14 Pro (16.2)",
                "iPad Pro (11-inch) (4th generation) (16.2)",
                # "Apple TV (16.1)",
            ]
        else
            raise "Unsupported iOS version: #{version}"
        end

        # if version == 13
        #     # we only build, not test, on iOS 13
        #     gym(
        #         devices: devices,
        #         scheme: "Introspect",
        #         skip_build: ci,
        #     )

        run_tests(
            devices: devices,
            ensure_devices_found: true,
            scheme: "Introspect",
            build_for_testing: version == 13, # only build on iOS 13, not test
        )
    end
end

platform :mac do
    lane :test do |options|
        puts 'Running on GitHub CI.' if options[:ci] == 'github'
        scan(
            scheme: "Introspect macOS",
            skip_build: options[:ci] == 'github'
        )
    end
end
