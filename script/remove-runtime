#!/usr/bin/env bash
set -euo pipefail

dryrun=false
if [[ "${1:-}" == "--dry-run" ]]; then
	dryrun=true
	shift
fi

platform="${1:-}"
version="${2:-}"

if [[ -z "$platform" || -z "$version" ]]; then
	echo "Usage: $0 [--dry-run] <platform> <version>"
	echo "Example: $0 --dry-run iOS 17.5"
	exit 1
fi

matches=()

while IFS= read -r -d '' runtime; do
	name="$(basename "$runtime")"
	if [[ "$name" == "$platform $version.simruntime" ]]; then
		matches+=("$runtime")
	fi
done < <(
	find /Library/Developer \
		-type d -name "*.simruntime" -prune -print0
)

if [[ ${#matches[@]} -eq 0 ]]; then
	echo "No matching runtime found: $platform $version"
	exit 1
fi

for runtime in "${matches[@]}"; do
	if $dryrun; then
		echo "Would remove: $runtime"
	else
		echo "Removing: $runtime"
		sudo rm -rf "$runtime"
	fi
done

echo "Processed ${#matches[@]} match(es)."
